#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <netinet/in.h>
#include <arpa/inet.h>

#define PORT 1337

void fatal(const char* msg);
void handle_client(int conn_fd, struct sockaddr_in* client_addr);
int start_server();

int main(void) {
  int sock_fd = start_server();

  printf("Pwnie wants connections on port %d\n", PORT);

  for(;;) {
    int conn_fd;
    struct sockaddr_in client_addr;
    socklen_t sin_size = sizeof(struct sockaddr);

    if ((conn_fd = accept(sock_fd, (struct sockaddr*)&client_addr, &sin_size)) == -1)
      fatal("accepting connection");

    handle_client(conn_fd, &client_addr);

    close(conn_fd);
  }

  return 0;
}

int start_server() {
  int sock_fd;
  socklen_t sin_size = sizeof(struct sockaddr);

  if ((sock_fd = socket(PF_INET, SOCK_STREAM, 0)) == -1)
    fatal("creating listening socket");

  int yes = 1;
  if (setsockopt(sock_fd, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(int)) == -1)
    fatal("setting socket option");

  struct sockaddr_in host_addr;
  host_addr.sin_family = AF_INET;
  host_addr.sin_port = htons(PORT);
  host_addr.sin_addr.s_addr = 0;
  memset(&(host_addr.sin_zero), 0, 8);

  if (bind(sock_fd, (struct sockaddr*)&host_addr, sin_size) == -1)
    fatal("binding to socket");

  if (listen(sock_fd, 5) == -1)
    fatal("listening on socket");

  return sock_fd;
}

void handle_client(int conn_fd, struct sockaddr_in* client_addr) {
    printf("Connection from %s on port %d\n",
           inet_ntoa(client_addr->sin_addr), ntohs(client_addr->sin_port));

    const char* banner = "Here be pwnies!\n";
    const int banner_len = strlen(banner);
    send(conn_fd, banner, banner_len, 0);

    // receive
    char echo[512];
    char* echo_ptr = echo;

    char buff[256];
    int recv_len = recv(conn_fd, &buff, 256, 0);
    int nl = 0;
    while (recv_len > 0) {
      for (int i = 0; i < recv_len; ++i) {
        if(buff[i] == '\n' || buff[i] == '\r') {
          nl = 1;
          recv_len = i;
          break;
        }
      }
      memcpy(echo_ptr, buff, recv_len);
      echo_ptr += recv_len;

      if (nl) break;

      recv_len = recv(conn_fd, &buff, 256, 0);
    }

    const char* imp = ", in my pants!\n";
    const int imp_len = strlen(imp);
    memcpy(echo_ptr, imp, imp_len);
    echo_ptr += imp_len;

    *echo_ptr = '\0';

    send(conn_fd, echo, echo_ptr - echo, 0);
}

void fatal(const char* msg) {
  printf("Fatal error: %s\n", msg);
  exit(1);
}
